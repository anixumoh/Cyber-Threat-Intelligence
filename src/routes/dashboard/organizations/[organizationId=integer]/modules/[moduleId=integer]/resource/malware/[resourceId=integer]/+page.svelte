<script lang="ts">
  import Client from '$lib/client';
  import ModuleHeading from '$lib/components/module/ModuleHeading.svelte';
  import { headerDetailsThreats } from '$lib/utils/headersDetailsThreats';
  import { onMount } from 'svelte';
  import threatsStore from '$stores/threats';
  import { currentOrganization } from '$stores/organization';
  import { currentModule } from '$stores/module';
  import { page } from '$app/stores';
  import Header from '$lib/components/ThreatsCommons/Details/Header.svelte';
  import ButtonsSection from '$lib/components/ThreatsCommons/Details/ButtonsSection.svelte';
  import DetailsHeader from '$lib/components/ThreatsCommons/Details/DetailsHeader.svelte';
  import { Loading, Tab, TabContent, Tabs } from 'carbon-components-svelte';
  import roleStore from '$stores/role';
  import ActionButton from '$lib/components/ThreatsCommons/Details/ActionButton.svelte';
  import CommonModal from '$lib/components/CommonModal/CommonModal.svelte';
  import Summary from '$lib/components/ThreatsCommons/Details/malware/Summary.svelte';
  import Static from '$lib/components/ThreatsCommons/Details/malware/Static.svelte';
  import Dynamic from '$lib/components/ThreatsCommons/Details/malware/Dynamic.svelte';
  import Network from '$lib/components/ThreatsCommons/Details/malware/Network.svelte';

  const client = new Client();

  let headerData = [];
  let isOpenAffectedFields = false;
  let affectedFields = [];

  onMount(async () => {
    $threatsStore.isLoadingDetails = true;
    await init();
    headerData = headerDetailsThreats[$currentModule.moduleName];
    return () => {
      client.abort();
    };
  });

  async function init() {
    $threatsStore.selectedForDetails = undefined;
    const { resourceId } = $page.params;
    await threatsStore.loadThreat(
      $currentOrganization.id,
      $currentModule.id,
      $currentModule?.moduleName,
      +resourceId,
      $page.url.pathname,
      true
    );
    parseAffectedFields($threatsStore?.selectedForDetails?.affectedFields);
  }

  function parseAffectedFields(affected: any[]) {
    if (affected) {
      const affectedTmp = [];
      Object.entries(affected).forEach?.(([key, value]) => {
        // const [key, value]: any = entry;
        const obj = { domain: key, affectedFields: value.affectedFields };
        affectedTmp.push(obj);
      });
      affectedFields = affectedTmp;
    }
  }
</script>

{#if $threatsStore.isLoadingDetails}
  <Loading />
{:else}
  <ModuleHeading isMainView={false} />
  <Header />
  <ButtonsSection />
  <DetailsHeader {headerData} />
  <div class="border-t-[1px] border-b-[1px] border-ctip-border bg-ctip-ui border-solid mt-3 p-2 flex justify-start">
    {#if !$roleStore.customer}
      <ActionButton
        isActive={isOpenAffectedFields}
        on:click={() => (isOpenAffectedFields = !isOpenAffectedFields)}
        text="View Affected fields"
      />
    {/if}
  </div>
  <Tabs class="mt-3">
    <Tab label="Summary" />
    <Tab label="Static" />
    <Tab label="Dynamic" />
    <Tab label="Network" />
    <svelte:fragment slot="content">
      <TabContent>
        <Summary />
      </TabContent>
      <TabContent>
        <Static />
      </TabContent>
      <TabContent>
        <Dynamic />
      </TabContent>
      <TabContent>
        <Network />
      </TabContent>
    </svelte:fragment>
  </Tabs>
{/if}

<CommonModal
  bind:open={isOpenAffectedFields}
  passiveModal
  modalHeading="Affected fields"
  on:closeModal={() => (isOpenAffectedFields = false)}
>
  {#each affectedFields as item}
    <span><strong>"{item.domain}"</strong> domain was found in:</span>
    <ul class="ml-8 list-disc">
      {#each item?.affectedFields as affected}
        <li>
          {affected}
        </li>
      {/each}
    </ul>
  {:else}
    <span>It has not affected fields</span>
  {/each}
</CommonModal>
