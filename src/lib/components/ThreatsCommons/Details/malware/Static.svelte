<script lang="ts">
  import InfoCard from '$lib/components/Card/InfoCard.svelte';
  import EmptyData from '$lib/components/EmptyData/EmptyData.svelte';
  import ResponsivePageNavigation from '$lib/components/ResponsivePageNavigation.svelte';
  import threatsStore from '$stores/threats';
  import { DataTable } from 'carbon-components-svelte';
  import { Archive, Code } from 'carbon-icons-svelte';
  import { onMount } from 'svelte';
  import ViewDetailsItem from '../../ViewDetailsItem.svelte';
  import GenericVerticalTab from './GenericVerticalTab.svelte';

  let pageSize = 10;
  let page = 1;

  let selectedIndex = 0;
  let compressedFileContents: any[];
  let sections;
  let dlls: any[] = [];
  let imports: any = {};
  let contentChild: any;
  let macros: {};
  let eps: any;
  let hasMacros: boolean;
  let changes: {};
  let contentChildPdfString: any;
  let contentChildPdf: any;
  let listKeys: { name: string; key: string }[];

  $: _content = Object.keys(imports);

  const typeOfPRotocols = {
    zip: 0,
    exe: 1,
    office: 2
  };

  $: numPages = $threatsStore.selectedForDetails?.staticc?.pe_sections.length
    ? Math.ceil($threatsStore.selectedForDetails?.staticc?.pe_sections.length / pageSize)
    : 0;

  onMount(() => {
    if ($threatsStore.selectedForDetails?.staticc?.type === 'exe') {
      parseExe();
    } else if ($threatsStore.selectedForDetails?.staticc?.type === 'zip') {
      parseZip();
    } else if ($threatsStore.selectedForDetails?.staticc?.type === 'office') {
      parseOffice();
    } else if ($threatsStore.selectedForDetails?.staticc?.type === 'pdf') {
      parsePdf();
    }
  });

  function parseZip() {
    compressedFileContents = mapZipContents($threatsStore.selectedForDetails?.staticc.compressed_files);
  }

  function parseExe() {
    let _static = $threatsStore.selectedForDetails?.staticc;
    _static.pe_imports.forEach((im) => {
      let dll = im.dll;
      dlls.push(dll);
      imports[dll] = im.imports;
    });
    sections = _static.pe_sections;
  }

  function parseOffice() {
    eps = $threatsStore.selectedForDetails?.staticc?.office?.eps;
    let macrosTmp = {};
    $threatsStore.selectedForDetails?.staticc?.office?.macros.forEach((e) => {
      macros[e.filename] = e;
    });
    hasMacros = !!$threatsStore.selectedForDetails?.staticc?.office?.macros.length;
    macros = macrosTmp;
  }

  function parsePdf() {
    if ($threatsStore.selectedForDetails?.staticc?.pdf) {
      if ($threatsStore.selectedForDetails?.staticc?.pdf?.metadata) {
        let _pdf = $threatsStore.selectedForDetails?.staticc?.pdf.metadata;
        let changesTmp = {};
        _pdf.forEach((e, key) => {
          if (e.creation !== '') {
            changesTmp[e.creation] = e;
          } else {
            changesTmp[key + 1] = e;
          }
        });
        changes = changesTmp;
        listKeys = [
          { name: 'Title', key: 'title' },
          { name: 'Subject', key: 'subject' },
          { name: 'Author', key: 'author' },
          { name: 'Creator', key: 'creator' },
          { name: 'Producer', key: 'producer' },
          { name: 'Version', key: 'version' }
        ];
      } else {
        contentChildPdfString = $threatsStore.selectedForDetails?.staticc?.pdf;
      }
    }
  }

  function mapZipContents(list) {
    let foldersHash = {};
    let firstLevel = [];
    let setToParent;
    setToParent = (element) => {
      let parentIndex = element.fullname.lastIndexOf('/');
      if (parentIndex > 0) {
        let path = element.fullname.substr(0, parentIndex);
        let parent = foldersHash[path];
        if (!parent) {
          parent = {
            type: 'folder',
            fullname: path,
            children: []
          };
          setToParent(parent);
          foldersHash[path] = parent;
        }
        element.name = element.fullname.substr(parentIndex + 1);
        parent.children.push(element);
      } else {
        element.name = element.fullname;
        firstLevel.push(element);
      }
    };
    list
      ?.filter?.((e) => e.md5 != null)
      .forEach((e) => {
        let data = {
          type: 'file',
          fullname: e.name,
          md5: e.md5,
          vtRatio: e.VirusTotal.detection_ratio,
          vtLink: e.VirusTotal.permalink,
          children: []
        };
        if (e.compressed_files) {
          data.type = 'zip';
          mapZipContents(e.compressed_files).forEach((e) => {
            data.children.push(e);
          });
        }
        setToParent(data);
      });
    return firstLevel;
  }

  function navigateToUrl(urlToOpen) {
    let url: string = '';
    if (!/^http[s]?:\/\//.test(urlToOpen)) {
      url += 'http://';
    }

    url += urlToOpen;
    window.open(url, '_blank');
  }

  function selectImport(key: string) {
    contentChild = imports[key].filter((element) => typeof element.name === 'string' && element.name.length);
  }

  function selectMacros(key: string) {
    contentChild = macros[key];
  }

  function selectPdf(key: string) {
    contentChildPdf = this.changes[key];
  }
</script>

{#if $threatsStore.selectedForDetails}
  <div class="grid lg:grid-cols-2 gap-4 my-3 m-2">
    {#if $threatsStore.selectedForDetails?.header?.packer}
      <ViewDetailsItem title="PACKER" value={$threatsStore.selectedForDetails.header.packer} icon={Archive} />
    {/if}
    {#if $threatsStore.selectedForDetails?.header?.yara}
      <ViewDetailsItem title="YARA" value={$threatsStore.selectedForDetails.header.yara} icon={Code} />
    {/if}
  </div>
{/if}

{#if $threatsStore.selectedForDetails?.staticc?.type === 'exe'}
  <InfoCard title="Sections" class="mt-3">
    <div class="w-full">
      {#if $threatsStore.selectedForDetails?.staticc?.pe_sections.length}
        <DataTable
          {pageSize}
          {page}
          headers={[
            { key: 'name', value: 'NAME' },
            { key: 'virtual_address', value: 'VIRTUAL ADDRESS' },
            { key: 'virtual_size', value: 'VIRTUAL SIZE' },
            { key: 'size_of_data', value: 'DATA SIZE' },
            { key: 'entropy', value: 'ENTROPY' }
          ]}
          rows={$threatsStore.selectedForDetails?.staticc?.pe_sections}
          class="[&_td]:text-center"
        />

        <div class="flex items-center">
          <ResponsivePageNavigation bind:page total={numPages} />
        </div>
      {:else}
        <EmptyData />
      {/if}
    </div>
  </InfoCard>
{/if}

{#if $threatsStore.selectedForDetails?.staticc?.type === 'zip'}
  <InfoCard title="Compressed Files" class="mt-3">
    {#if compressedFileContents?.length}
      <ul>
        {#each compressedFileContents as file}
          <li>
            <span>{file.name}</span>
            {#if file.vtLink}
              <button class="btn btn-primary btn-xs pull-right" on:click={() => navigateToUrl(file.vtLink)}>
                {file.vtRatio}
              </button>
            {/if}
          </li>
        {/each}
      </ul>
    {:else}
      <div class="flex justify-center w-full">
        <EmptyData messageObj={{ msg: 'There is no ZIP report for this sample' }} />
      </div>
    {/if}
  </InfoCard>
{:else if $threatsStore.selectedForDetails?.staticc?.type === 'exe'}
  <InfoCard title="Imports" class="mt-3">
    {#if !sections?.length}
      <div class="flex justify-center w-full">
        <EmptyData messageObj={{ msg: 'There is no ZIP report for this sample' }} />
      </div>
    {:else}
      <GenericVerticalTab
        tabsTitle="DLL"
        contentTitle="Api calls"
        content={_content}
        on:selectImport={(event) => selectImport(event.detail.key)}
      >
        {#if contentChild}
          <div class="border-t-2">
            <ul class="overflow-y-scroll h-80">
              {#each contentChild as child}
                <li class="px-3 py-2 border-0 hover:bg-ctip-light hover:text-ctip-primary">
                  {child.name}
                </li>
              {/each}
            </ul>
          </div>
        {/if}
      </GenericVerticalTab>
    {/if}
  </InfoCard>
{:else if $threatsStore.selectedForDetails?.staticc?.type === 'office'}
  <InfoCard title="Macros" class="mt-3">
    {#if !sections?.length}
      <div class="flex justify-center w-full">
        <EmptyData messageObj={{ msg: 'There is no ZIP report for this sample' }} />
      </div>
    {:else}
      <GenericVerticalTab
        tabsTitle="Filename"
        contentTitle="Macros"
        content={macros}
        on:selectImport={(event) => selectMacros(event.detail.key)}
      >
        {#if contentChild}
          <header class="text-2xl text-ctip-primary">
            <h4><b>Stream:</b> {contentChild.stream}</h4>
          </header>
          <article>
            <div class="columns-6">
              <h4>Original code</h4>
              <pre>{contentChild.orig_code}</pre>
            </div>
            <div class="columns-6">
              <h4>Deobfuscated code</h4>
              <pre>{contentChild.deobf}</pre>
            </div>
          </article>
        {/if}
      </GenericVerticalTab>
    {/if}
  </InfoCard>
{:else}
  <div class="flex justify-center w-full">
    <EmptyData messageObj={{ msg: 'No data' }} />
  </div>
{/if}

{#if changes}
  <InfoCard title="Changes" class="mt-3">
    {#if $threatsStore.selectedForDetails?.staticc?.type === 'pdf'}
      {#if changes || contentChildPdfString}
        {#if contentChildPdfString}
          {contentChildPdfString}
        {:else}
          <GenericVerticalTab
            tabsTitle="Change"
            contentTitle="Information"
            content={changes}
            on:selectImport={(event) => selectPdf(event.detail.key)}
          >
            {#if contentChildPdf}
              <ul>
                {#each listKeys as field}
                  <li>
                    {contentChildPdf[field.key]}
                  </li>
                {/each}
              </ul>
              {#if contentChildPdf?.urls?.length}
                <div>
                  <h4>URLS</h4>
                  <ul>
                    {#each contentChildPdf.urls as url}
                      <li>
                        {url}
                      </li>
                    {/each}
                  </ul>
                </div>
              {/if}
              {#if contentChildPdf?.javascript?.length}
                <div>
                  <div class="text-2xl text-ctip-primary">
                    <h3>Javascripts</h3>
                  </div>
                  {#each contentChildPdf.javascript as js}
                    <pre>
                                {js.orig_code}
                              </pre>
                  {/each}
                </div>
              {/if}
            {/if}
          </GenericVerticalTab>
        {/if}
      {/if}
    {/if}
  </InfoCard>
{/if}
