<script lang="ts">
  import InfoCard from '$lib/components/Card/InfoCard.svelte';
  import EmptyData from '$lib/components/EmptyData/EmptyData.svelte';
  import ResponsivePageNavigation from '$lib/components/ResponsivePageNavigation.svelte';
  import Severity from '$lib/components/ThreatsCommons/Severity/index.svelte';
  import threatsStore from '$stores/threats';
  import { DataTable, TooltipDefinition, truncate } from 'carbon-components-svelte';

  let pageSize = 10;
  let page = 1;
  let pageDns = 1;
  let pageHosts = 1;
  let pageHttp = 1;

  $: numPages = $threatsStore.selectedForDetails?.summary?.signatures?.length
    ? Math.ceil($threatsStore.selectedForDetails?.summary?.signatures?.length / pageSize)
    : 0;

  $: numPagesDns = $threatsStore.selectedForDetails?.network?.domains?.length
    ? Math.ceil($threatsStore.selectedForDetails?.network?.domains.length / pageSize)
    : 0;

  $: numPagesHosts = $threatsStore.selectedForDetails?.network?.hosts?.length
    ? Math.ceil($threatsStore.selectedForDetails?.network?.hosts.length / pageSize)
    : 0;

  $: numPagesHttp = $threatsStore.selectedForDetails?.network?.http?.length
    ? Math.ceil($threatsStore.selectedForDetails?.network?.http.length / pageSize)
    : 0;
</script>

<InfoCard title="Signatures" class="mt-3">
  <div class="w-full">
    {#if $threatsStore.selectedForDetails?.summary?.signatures?.length}
      <DataTable
        {pageSize}
        {page}
        headers={[
          { key: 'description', value: 'DESCRIPTION' },
          { key: 'severity', value: 'SEVERITY' }
        ]}
        rows={$threatsStore.selectedForDetails.summary.signatures}
        class="[&_td]:text-left"
      >
        <svelte:fragment slot="cell" let:cell let:row>
          {#if cell.key === 'description'}
            <b class="mb-0 font-bold">{row.name}</b>
            <p class="font-medium mb-0">{row.description}</p>
          {:else if cell.key === 'severity'}
            <Severity severity={row.severity} />
          {:else}
            <span class="flex text-center justify-center">
              {cell.value}
            </span>
          {/if}
        </svelte:fragment>
      </DataTable>
      <div class="flex items-center">
        <ResponsivePageNavigation bind:page total={numPages} />
      </div>
    {:else}
      <EmptyData />
    {/if}
  </div>
</InfoCard>
<InfoCard title="DNS Resolutions" class="mt-3">
  <div class="w-full">
    {#if $threatsStore.selectedForDetails?.network?.domains?.length}
      <DataTable
        {pageSize}
        page={pageDns}
        headers={[
          { key: 'domain', value: 'DNS' },
          { key: 'ip', value: 'ADDRESS' }
        ]}
        rows={$threatsStore.selectedForDetails.network.domains}
        class="[&_td]:text-center"
      />

      <div class="flex items-center">
        <ResponsivePageNavigation bind:page={pageDns} total={numPagesDns} />
      </div>
    {:else}
      <EmptyData />
    {/if}
  </div>
</InfoCard>
<InfoCard title="Connections" class="mt-3">
  <div class="w-full">
    {#if $threatsStore.selectedForDetails?.network?.hosts?.length}
      <DataTable
        {pageSize}
        page={pageHosts}
        headers={[
          { key: 'address', value: 'ADDRESS' },
          { key: 'port', value: 'PORT' },
          { key: 'protocol', value: 'PROTOCOL' }
        ]}
        rows={$threatsStore.selectedForDetails.network.hosts}
        class="[&_td]:text-center"
      />

      <div class="flex items-center">
        <ResponsivePageNavigation bind:page={pageHosts} total={numPagesHosts} />
      </div>
    {:else}
      <EmptyData />
    {/if}
  </div>
</InfoCard>
<InfoCard title="HTTP Requests" class="mt-3">
  <div class="w-full">
    {#if $threatsStore.selectedForDetails?.network?.http?.length}
      <DataTable
        {pageSize}
        page={pageHttp}
        headers={[
          { key: 'destination', value: 'DESTNATION' },
          { key: 'method', value: 'METHOD' },
          { key: 'uri', value: 'URL' },
          { key: 'data', value: 'DATA' }
        ]}
        rows={$threatsStore.selectedForDetails.network.http}
        class="[&_td]:text-center"
      >
        <svelte:fragment slot="cell" let:cell let:row>
          {#if cell.key === 'data'}
            <TooltipDefinition tooltipText={row.data} direction="top">
              <span use:truncate class="max-w-[500px]">{row.data}</span>
            </TooltipDefinition>
          {:else}
            {cell.value}
          {/if}
        </svelte:fragment>
      </DataTable>

      <div class="flex items-center">
        <ResponsivePageNavigation bind:page={pageHttp} total={numPagesHttp} />
      </div>
    {:else}
      <EmptyData />
    {/if}
  </div>
</InfoCard>
