<script lang="ts">
  import type { TCXCVESingleResponse } from '$lib/types/tcx';
  import { Button, DataTable, PaginationNav } from 'carbon-components-svelte';
  import type { DataTableHeader } from 'carbon-components-svelte/types/DataTable/DataTable.svelte';
  import { Launch } from 'carbon-icons-svelte';

  const headers: DataTableHeader[] = [
    { key: 'name', value: 'NAME' },
    { key: 'author', value: 'AUTHOR' },
    { key: 'type', value: 'TYPE' },
    { key: 'platform', value: 'PLATFORM' },
    { key: 'source', value: 'SOURCE', display: (row) => getSource(row.url) },
    { key: 'date', value: 'DATE' },
    { key: 'url', value: 'URL' }
  ];

  const pageSize = 5;

  export let cveResponse: TCXCVESingleResponse;

  let page = 1;

  $: rows = cveResponse.data.attributes.exploits;
  $: totalPages = Math.ceil(rows.length / pageSize);

  function getSource(url: string) {
    try {
      return new URL(url).hostname;
    } catch {
      return '';
    }
  }
</script>

<DataTable
  class="[&_td]:whitespace-nowrap overflow-x-auto"
  {page}
  {pageSize}
  title="Exploits"
  {headers}
  rows={rows.map((row, i) => ({ ...row, id: i }))}
>
  <svelte:fragment slot="cell" let:cell let:row>
    {#if cell.key === 'name'}
      <div class="max-w-sm whitespace-break-spaces">{cell.value}</div>
    {:else if cell.key === 'url'}
      <Button
        tooltipAlignment="end"
        tooltipPosition="top"
        kind="ghost"
        size="small"
        href={row.url}
        icon={Launch}
        iconDescription={row.url}
        target="_blank"
      />
    {:else}
      <div class="flex items-center justify-center">
        {(cell.display ? cell.display(row) : cell.value) ?? '-'}
      </div>
    {/if}
  </svelte:fragment>
</DataTable>

{#if totalPages > 1}
  <PaginationNav bind:page total={totalPages} />
{/if}
