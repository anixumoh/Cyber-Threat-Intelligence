<!-- MAIN HEADER -->

<div class="main-header mt-4 mb-3 clearfix">
  <div class="row align-items-end justify-content-md-center">
    <div class="col-md-3">
      <h6 class="text-muted text-uppercase text-90 font-weight-bold mb-3 mt-1">Malware Hunting</h6>
      <h5 class="text-dark float-left mb-0">{{ activeModule?.name }}</h5>
    </div>
    <div class="col-md-6">
      <app-ctx-search
        [tcxType]="'malwareHunting'"
        [searchText]="searchText"
        [showSaveSearchButton]="showSaveSearchButton"
        (searchEvent)="search()"
        (clearSearchTermEvent)="onClearSearchTerm()"
        (openModalDorksEvent)="onOpenModalDorks($event)"
        (searchTextChangeEvent)="onSetSearchTerm($event)"
      ></app-ctx-search>
      <div *ngIf="listError" class="text-danger">{{ listError }}</div>
      <app-tcx-quick-filters
        [tcxType]="'malwareHunting'"
        [items]="quickFilters"
        (changeMethod)="onChangeQuickFilter($event)"
      ></app-tcx-quick-filters>
    </div>
    <div class="col-md-3">
      <app-info-button [activeModule]="activeModule"></app-info-button>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="d-flex align-items-center justify-content-between rounded-top bg-light p-2 mx-0 fixed-scroll">
    <div class="d-flex align-items-center">
      <div class="pr-3 border-right mr-3">
        <div class="button-action" ngbDropdown>
          <button
            ngbDropdownToggle
            [disabled]="!hasSomeChecked()"
            class="btn btn-light btn-sm border px-2 float-left btn-actions"
            [ngClass]="{ pulse: hasSomeChecked() }"
            type="button"
            id="actionsButtonDropdown"
            name="button"
          >
            <i class="icon-ellipsis-v px-1"></i>
          </button>
          <div ngbDropdownMenu class="actions-dropdown-menu">
            <ul aria-labelledby="actionsButtonDropdown" class="list-group actions-menu shadow border rounded">
              <li
                class="list-group-item list-group-item-action cursor-pointer border-0 px-3 py-2"
                (click)="exportToCSV()"
              >
                <i class="icon-share-square mr-2"></i>
                <span>Export to CSV</span>
              </li>
              <li
                class="list-group-item list-group-item-action cursor-pointer border-0 px-3 py-2"
                (click)="exportToJson()"
              >
                <i class="icon-share-square mr-2"></i>
                <span>Export to JSON</span>
              </li>
              <li
                class="list-group-item list-group-item-action cursor-pointer border-0 px-3 py-2"
                (click)="copyToClipboard('md5')"
              >
                <i class="icon-copy mr-2"></i>
                <span>Copy MD5 to clipboard</span>
              </li>
              <li
                class="list-group-item list-group-item-action cursor-pointer border-0 px-3 py-2"
                (click)="copyToClipboard('sha1')"
              >
                <i class="icon-copy mr-2"></i>
                <span>Copy SHA1 to clipboard</span>
              </li>
              <li
                class="list-group-item list-group-item-action cursor-pointer border-0 px-3 py-2"
                (click)="copyToClipboard('sha256')"
              >
                <i class="icon-copy mr-2"></i>
                <span>Copy SHA256 to clipboard</span>
              </li>
              <li
                class="list-group-item list-group-item-action cursor-pointer border-0 px-3 py-2"
                (click)="copyToClipboard('*')"
              >
                <i class="icon-copy mr-2"></i>
                <span>Copy all hashes to clipboard</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <h6 class="d-flex align-items-center mb-0">
        <span>Malware Hunting showing:</span>
        <span *ngIf="!loading" class="badge badge-pill badge-primary ml-2">{{ totalResources | number }} results</span>
        <i class="icon-spinner rotate text-primary ml-2" *ngIf="loading"></i>
      </h6>
    </div>
    <app-select
      *ngIf="items?.length > 0"
      class="float-right"
      [items]="limits"
      [model]="limit"
      [icon]="'icon-format_list_bulleted'"
      [placement]="'bottom-right'"
      id="limitDropdown"
      (onChange)="onChangeLimit($event)"
    >
    </app-select>
  </div>

  <div *ngIf="uiDownloadingByHashState.indexing === downloadingByHashState">
    <div class="app-component-wrapper">
      <div>
        <img src="/assets/default_images/searching.svg" class="robot" alt="" />
      </div>
      <div>
        <div class="text-large">Malware downloaded successfully!</div>
        <div class="text-medium">Indexing malware, please wait...</div>
      </div>
    </div>
  </div>

  <request-download-malware-by-hash
    *ngIf="uiDownloadingByHashState.downlading === downloadingByHashState"
    [hash]="malwareHashToDownload"
    (completed)="onMalwareDownloadComplete($event)"
  ></request-download-malware-by-hash>
  <!-- TABLE -->
  <app-table
    [items]="items"
    [loading]="loading"
    class="table-fixed table--sticky table--sticky-fixed-scroll"
    *ngIf="uiDownloadingByHashState.listing === downloadingByHashState"
  >
    <thead>
      <tr>
        <th class="text-center td-30">
          <input type="checkbox" [(ngModel)]="bulk" (click)="setCheckedState($event)" />
        </th>
        <th style="width: 100px">First Seen</th>
        <th>Sha256</th>
        <th class="text-center">Score</th>
        <th>Sources</th>
        <th>Type</th>
        <th class="text-center">Status</th>
        <th class="text-center">#PROP</th>
        <th class="text-center" style="width: 6%">NET</th>
        <th class="text-center" style="width: 6%">C&C</th>
        <th class="text-center" style="width: 7%">URLs</th>
        <th class="text-center">File Type</th>
      </tr>
    </thead>
    <tbody>
      <tr
        *ngFor="let item of items; let index = index"
        [ngClass]="{ 'no-details': !item.hasDetails }"
        class="cursor-pointer"
        (click)="navigateToDetail($event, item)"
      >
        <td class="text-center td-40 vertical-middle cursor-default" (click)="$event.stopImmediatePropagation()">
          <input type="checkbox" class="cursor-pointer" [(ngModel)]="item.fxSelected" (click)="setChecked()" />
        </td>
        <td class="align-middle text-center truncate-lineal" style="width: 15%">
          <app-large-text [value]="item.attributes.first_seen | date: 'dd/MM/yyyy'"></app-large-text>
        </td>
        <td class="align-middle no-white-space" style="width: 22%">
          <app-copy-to-clipboard [value]="item.attributes.sha256" [tooltip]="true"></app-copy-to-clipboard>
        </td>
        <td class="align-middle text-center">{{ score(item.attributes.cerberus) }}</td>
        <td class="align-middle truncate-lineal" style="width: 10%">
          <app-large-text [value]="join(item.attributes.sources_representation, ', ')"></app-large-text>
        </td>
        <td class="align-middle truncate-lineal" style="width: 10%">
          <app-large-text [value]="join(item.attributes.types_names, ', ')"></app-large-text>
        </td>
        <td class="align-middle text-center td-50">
          <i [class]="item.statusIconClass" [ngbTooltip]="item.attributes.analysis_status"></i>
        </td>
        <td class="align-middle text-center">{{ item.attributes.number_properties }}</td>
        <td class="align-middle text-center" style="width: 50px">
          <app-boolean [value]="item.attributes.has_network"></app-boolean>
        </td>
        <td class="align-middle text-center" style="width: 50px">
          <app-boolean [value]="item.attributes.has_c_and_c"></app-boolean>
        </td>
        <td class="align-middle text-center" style="width: 50px">
          <app-boolean [value]="item.attributes.has_other_urls"></app-boolean>
        </td>
        <td class="align-middle text-center">{{ item.attributes.file_type }}</td>
      </tr>
    </tbody>
  </app-table>
  <!-- PAGINATION -->
  <div class="float-left p-2">
    <app-pagination-x [page]="page" [count]="count" [pageSize]="limit" (pageChange)="onPageChange($event)">
    </app-pagination-x>
  </div>
</div>
<!-- MODAL -->
<modal-window
  modalTitle="Advanced Search: Available Dorks"
  dorksThreathContext="dorksThreathContext"
  dorksThreathContextType="malware-hunting"
  (changeDork)="setDork($event)"
  *ngIf="openModalDorks"
  [customClass]="'modal-xl'"
  [dorkFields]="dorkFields"
  cancelBtn="Close"
  [closeBtn]="true"
  (cancel)="openModalDorks = false"
>
</modal-window>

<app-modal [show]="showModal" (close)="showModal = false">
  <div class="modal-content">
    <div class="card">
      <div class="modal-header bg-light">
        <h5 class="modal-title mb-0 pull-left">
          <i class="icon-blv-warning text-warning" style="font-size: 22px"></i> Warning
        </h5>
        <button type="button" class="close pull-right" (click)="showModal = false" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p style="font-size: 16px">
          Unfortunately, the maximum number of elements to be searched was reached. The last element looked up was:
          <br />
          <b>{{ lastItem || '' }}</b>
        </p>
      </div>
      <div class="card-footer text-right">
        <button class="btn btn-light text-danger btn-sm" (click)="showModal = false">Close</button>
      </div>
    </div>
  </div>
</app-modal>
