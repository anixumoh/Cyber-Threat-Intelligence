import { Component, Input, OnDestroy, OnInit, ViewEncapsulation } from '@angular/core';
import { Subject } from 'rxjs';
import { take, takeUntil } from 'rxjs/operators';

import { OrganizationService } from '../../../../../dashboard/organization/organization.service';

@Component({
  selector: 'strings-array',
  templateUrl: './simpleStringsArray.html',
  styleUrls: ['./simpleStringArray.scss'],
  encapsulation: ViewEncapsulation.None,
})
export class SimpleStringsArray implements OnInit, OnDestroy {
  @Input() parentKey = undefined;
  @Input() key = undefined;
  @Input() value = undefined;

  activeModule;
  activeOrganization;
  strArray;
  complete_key;
  is_ip = false;
  is_domain = false;
  is_host = false;
  private readonly destroy$ = new Subject<void>();

  constructor(private organizationService: OrganizationService) {}

  ngOnInit() {
    this.organizationService
      .getCurrentContext()
      .pipe(takeUntil(this.destroy$), take(1))
      .subscribe((context) => {
        this.activeModule = context.currentModule;
        this.activeOrganization = context.currentOrganization;
      });

    this.process_array();
  }

  ngOnDestroy() {
    this.destroy$.next();
    this.destroy$.complete();
  }

  getQueryParams(key, value) {
    return { dork: `ioa.${key}.keyword:"${value}"` };
  }

  private process_array() {
    this.strArray = this.value;

    this.complete_key = this.parentKey ? this.parentKey + '.' + this.key : this.key;

    if (this.key === 'ip') {
      this.is_ip = true;
    }
    if (this.key === 'domains') {
      this.is_domain = true;
    }
    if (this.key === 'host') {
      this.is_host = true;
    }
  }

  private isNetworkKey() {
    return this.is_ip || this.is_domain || this.is_host;
  }

  private getVTUrl(value) {
    if (this.is_ip) {
      return 'https://www.virustotal.com/ip-address/' + value + '/information/';
    }
    if (this.is_domain) {
      return 'https://www.virustotal.com/domain/' + value + '/information/';
    }
    if (this.is_host) {
      return 'https://www.virustotal.com/domain/' + value + '/information/';
    }
  }
}
