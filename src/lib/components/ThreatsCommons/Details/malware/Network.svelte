<script lang="ts">
  import InfoCard from '$lib/components/Card/InfoCard.svelte';
  import EmptyData from '$lib/components/EmptyData/EmptyData.svelte';
  import ResponsivePageNavigation from '$lib/components/ResponsivePageNavigation.svelte';
  import threatsStore from '$stores/threats';
  import { ContentSwitcher, DataTable, Switch } from 'carbon-components-svelte';
  import NetworkHttp from './NetworkHttp.svelte';
  import NetworkTcp from './NetworkTcp.svelte';

  let pageSize = 10;
  let page = 1;

  let selectedIndex = 0;

  $: numPages = $threatsStore.selectedForDetails?.network?.dns?.length
    ? Math.ceil($threatsStore.selectedForDetails?.network?.dns?.length / pageSize)
    : 0;
</script>

<InfoCard title="DNS" class="mt-3">
  <div class="w-full">
    {#if $threatsStore.selectedForDetails?.network?.dns}
      <DataTable
        {pageSize}
        {page}
        headers={[
          { key: 'request', value: 'NAME' },
          { key: 'type', value: 'TYPE' },
          { key: 'response', value: 'RESPONSE' }
        ]}
        rows={$threatsStore.selectedForDetails.network.dns}
        class="[&_td]:text-center"
      >
        <svelte:fragment slot="cell-header" let:header>
          {#if header.key === 'request'}
            <span class="flex text-left justify-start">
              {header.value}
            </span>
          {:else}
            {header.value}
          {/if}
        </svelte:fragment>
        <svelte:fragment slot="cell" let:cell let:row>
          {#if cell.key === 'response'}
            {#each row.response as response}
              <p class="font-medium mb-0">{response}</p>
            {/each}
          {:else if cell.key === 'request'}
            <span class="flex text-left justify-start">
              {cell.value}
            </span>
          {:else}
            <span class="flex text-center justify-center">
              {cell.value}
            </span>
          {/if}
        </svelte:fragment>
      </DataTable>
      <div class="flex items-center">
        <ResponsivePageNavigation bind:page total={numPages} />
      </div>
    {:else}
      <EmptyData />
    {/if}
  </div>
</InfoCard>
<InfoCard title="Protocols" class="mt-3">
  <div class="flex flex-col w-full">
    <ContentSwitcher bind:selectedIndex>
      <Switch text="HTTP" />
      <Switch text="HTTPS" />
      <Switch text="TCP" />
      <Switch text="UDP" />
    </ContentSwitcher>
    {#if selectedIndex === 0}
      <NetworkHttp elements={$threatsStore.selectedForDetails?.network?.protocols?.http} />
    {:else if selectedIndex === 1}
      <NetworkHttp elements={$threatsStore.selectedForDetails?.network?.protocols?.https} />
    {:else if selectedIndex === 2}
      <NetworkTcp elements={$threatsStore.selectedForDetails?.network?.protocols?.tcp} />
    {:else}
      <NetworkTcp elements={$threatsStore.selectedForDetails?.network?.protocols?.udp} />
    {/if}
  </div>
</InfoCard>
