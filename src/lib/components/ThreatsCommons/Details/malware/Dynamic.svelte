<script lang="ts">
  import GenericButton from '$lib/components/Buttons/GenericButton.svelte';
  import InfoCard from '$lib/components/Card/InfoCard.svelte';
  import EmptyData from '$lib/components/EmptyData/EmptyData.svelte';
  import threatsStore from '$stores/threats';
  import { FlashFilled, WarningAltFilled } from 'carbon-icons-svelte';
  import { isEmpty } from 'lodash';
  import { onMount } from 'svelte';

  let firstLevel: any[];
  let dropped: any[];
  let droppedPre: any[];
  let extraDropped: any[];
  let behavior: any;
  let hash = {};
  let hasGraph = false;
  let hasData = false;
  let showMoreOpened = false;

  onMount(() => {
    init();
  });

  function init() {
    droppedPre = $threatsStore.selectedForDetails?.dropped?.dropped?.length
      ? $threatsStore.selectedForDetails?.dropped?.dropped
      : [];
    behavior = $threatsStore.selectedForDetails?.behavior ?? {};
    manageDropped();
    if (!isEmpty(behavior)) {
      if ($threatsStore.selectedForDetails?.dropped?.cuckooVersion === '1.0') {
        genericProcessV1();
      } else {
        genericProcessV2();
      }
      const processSize = behavior?.processes?.length;
      const levelsSize = getCallLevels(firstLevel, 0);
      hasGraph = processSize < 15 || levelsSize <= 4;
    }
    hasData = !!firstLevel?.length || !!dropped?.length;
  }

  function manageDropped() {
    if (droppedPre === null) {
      droppedPre = [];
    }

    const malicious = [];
    const suspicious = [];
    const nonMalicious = [];
    droppedPre.forEach((item, i) => {
      if (item.malware_type) {
        if (item.malware_type === 'UNCLASSIFIED') {
          suspicious.push(item);
          item.kind = 'suspicious';
        } else {
          malicious.push(item);
          item.kind = 'malicious';
        }
      } else {
        nonMalicious.push(item);
        item.kind = '';
      }
      hash[item.sha1] = item;
      if (item.content !== '[!] Omitting remaining dropped files content') {
        item.strings = item.content.split('\n');
      }
      const vt = item.virustotal;
      if (vt?.summary?.detection_ratio) {
        item.virusTotal = vt.summary.detection_ratio;
      }
    });

    dropped = malicious.concat(suspicious).concat(nonMalicious).slice(0, 2);
    extraDropped = malicious.concat(suspicious).concat(nonMalicious).slice(2);
  }

  function getCallLevels(list, level) {
    let maxLevel = level;
    list.forEach((e) => {
      let newLevels = getCallLevels(e.children, level + 1);
      if (maxLevel < newLevels) {
        maxLevel = newLevels;
      }
    });
    return maxLevel;
  }

  function genericProcessV1() {
    firstLevel = [];
    behavior.processes.forEach((process) => {
      hash[process.process_id] = process;
      process.children = [];
      process.pid = process.process_id;
    });

    behavior.processes.forEach((process) => {
      const process_id = process.process_id;
      const parent = hash[process.parent_id];
      const elem = hash[process_id];
      if (parent) {
        parent.children.push(elem);
      } else {
        firstLevel.push(elem);
      }
      elem.summary = {};
      elem.summary.apistats = [];
    });
    behavior.processes.forEach((e) => {
      if (!e.summary) {
        e.summary = {
          children: []
        };
      }
      e.summary.children = e.children.map((e) => `${e.process_id} > ${e.process_name}`);
      e.firstSeen = new Date(e.first_seen.replace(',', '.')).toISOString();
    });
  }

  function genericProcessV2() {
    firstLevel = [];
    behavior.processes.forEach((process) => {
      hash[process.pid] = process;
      process.children = [];
    });
    if (!behavior.generic) {
      behavior.generic = [];
    }
    behavior.generic.forEach((process) => {
      const pid = process.pid;
      const parent = hash[process.ppid];
      const elem = hash[pid];
      if (elem) {
        if (parent) {
          parent.children.push(elem);
        } else {
          firstLevel.push(elem);
        }

        elem.malware_type = process.malware_type;

        elem.summary = process.summary;
        const objApiStats = behavior.apistats[pid];
        if (objApiStats) {
          const apiStats = Object.keys(objApiStats).map((key) => {
            return key + ':' + objApiStats[key];
          });
          elem.summary.apistats = apiStats;
        } else {
          elem.summary.apistats = [];
        }
      }
    });
    behavior.processes.forEach((e) => {
      if (!e.summary) {
        e.summary = {
          children: []
        };
      }
      e.summary.children = e.children.map((e) => {
        return e.pid + '>' + e.process_name;
      });
      if (typeof e.first_seen == 'string') {
        e.firstSeen = Date.parse(e.first_seen.split(',')[0]);
      } else {
        e.firstSeen = new Date(e.first_seen * 1000).toISOString();
      }
    });
  }

  function openContent(file) {
    // In angular this function not open anything
  }

  function toogleShowMore() {
    showMoreOpened = !showMoreOpened;
  }
</script>

<!-- In Angular the component not show anything -->
<!-- <InfoCard title="Processes created">
  {#if firstLevel?.length}
    <span>has first level</span>
  {:else}
    <div class="flex justify-center w-full">
      <EmptyData messageObj={{ msg: 'There is no information for Process Tree in this sample' }} />
    </div>
  {/if}
</InfoCard> -->

<InfoCard title="Dropped files" class="mt-3">
  {#if dropped?.length}
    <div class="py-3 px-0">
      <div class="text-sm text-ctip-secondary">
        {#each dropped as item}
          <p class="cursor-pointer" on:click={() => openContent(item)}>
            {#if item.kind === 'malicious'}
              <FlashFilled />
            {:else if item.kind === 'suspicious'}
              <WarningAltFilled />
            {/if}
            <span>{item.name}</span>
          </p>
        {:else}
          <span>Not data</span>
        {/each}
        {#if showMoreOpened}
          {#each extraDropped as item}
            <p class="cursor-pointer" on:click={() => openContent(item)}>
              {#if item.kind === 'malicious'}
                <FlashFilled />
              {:else if item.kind === 'suspicious'}
                <WarningAltFilled />
              {/if}
              <span>{item.name}</span>
            </p>
          {/each}
        {/if}
      </div>
    </div>
    {#if extraDropped?.length}
      <GenericButton on:click={toogleShowMore}
        >{showMoreOpened ? 'Hide some dropped files' : 'Show all dropped files'}</GenericButton
      >
    {/if}
  {:else}
    <div class="flex justify-center w-full">
      <EmptyData messageObj={{ msg: 'There are no Dropped Files' }} />
    </div>
  {/if}
</InfoCard>
