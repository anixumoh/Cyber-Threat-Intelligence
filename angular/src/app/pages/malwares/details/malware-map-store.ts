import { take } from 'rxjs/operators';
import { Injectable } from '@angular/core';
import { BehaviorSubject } from 'rxjs';
import { MalwaresService } from '../../../core/models/malwares.service';

@Injectable()
export class MalwareMapStore {
  private _state = new BehaviorSubject(null);
  private countrySVG =
    'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z';
  private countryData = {
    latitude: null,
    longitude: null,
    svgPath: this.countrySVG,
    color: '#CC0000',
    animateAlongLine: true,
    scale: 1,
    zoomLevel: 5,
    title: null
  };

  constructor(private malwaresService: MalwaresService) {}

  getData(malwareId) {
    this.malwaresService
      .getMap(malwareId, 'ip-country')
      .pipe(take(1))
      .subscribe((result: any) => {
        const mapData = [];
        for (const country of result.data) {
          const c = Object.assign({}, this.countryData);
          c.latitude = country.attributes.latitude;
          c.longitude = country.attributes.longitude;
          c.title = `${country.attributes.name}<br/>${country.attributes.count} IPs`;
          mapData.push(c);
        }
        this.setState(mapData);
      });
  }

  get state$() {
    return this._state;
  }

  get state() {
    return this._state.getValue();
  }

  setState(newState) {
    this._state.next(newState);
  }
}
